---
title: Homework_6_Part_1
output: html_document
---

```{r}
rm(list = ls())#start fresh
```

```{r set-cran-mirror} 
options(repos = "https://cloud.r-project.org")
``` 
```{r}
#the above code was necessary to run the knit process so that r knows where to download the packages from.
```


```{r}
# Install the openxlsx package
install.packages("openxlsx")

# Load the openxlsx library
library(openxlsx)
```

```{r}
#read all the files from the download

FSI_2006=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2006.xlsx")
FSI_2007=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2007.xlsx")
FSI_2008=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2008.xlsx")
FSI_2009=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2009.xlsx")
FSI_2010=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2010.xlsx")
FSI_2011=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2011.xlsx")
FSI_2012=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2012.xlsx")
FSI_2013=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2013.xlsx")
FSI_2014=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2014.xlsx")
FSI_2015=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2015.xlsx")
FSI_2016=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2016.xlsx")
FSI_2017=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2017.xlsx")
FSI_2018=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2018.xlsx")
FSI_2019=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2019.xlsx")
FSI_2020=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2020.xlsx")
FSI_2021=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2021.xlsx")
FSI_2022=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/fsi-2022-download.xlsx")
FSI_2023=read.xlsx("https://github.com/Fundamentals-Josh/Week_6_Exercise_1/raw/refs/heads/main/FSI%20File%20Downloads/FSI-2023-DOWNLOAD%20(3).xlsx")
```

```{r}
# Create a list of the dataframe names
df_names = c(
  "FSI_2006", "FSI_2007", "FSI_2008", "FSI_2009", "FSI_2010",
  "FSI_2011", "FSI_2012", "FSI_2013", "FSI_2014", "FSI_2015",
  "FSI_2016", "FSI_2017", "FSI_2018", "FSI_2019", "FSI_2020",
  "FSI_2021", "FSI_2022", "FSI_2023"
)

# Loop through each dataframe name and print its column names
for (name in df_names) {
  if (exists(name)) {
    df = get(name) # Get the dataframe object from its name
    cat(paste0("Column names for ", name, ":\n"))
    print(names(df))
    cat("\n") # Add a newline for better readability between dataframes
  } else {
    cat(paste0("DataFrame ", name, " does not exist.\n\n"))
  }
}
```

```{r}
#data cleaning step: remove "Change.from.Previous.Year" from 2019 and 2020 files. Then show the head for both files to confirm execution.

FSI_2019$Change.from.Previous.Year <- NULL
FSI_2020$Change.from.Previous.Year <- NULL

head(FSI_2019,10)
head(FSI_2020,10)
```

```{r}
# Create a list of the dataframe names (assuming df_all_years is defined from previous cells)
df_all_years = c(
  "FSI_2006", "FSI_2007", "FSI_2008", "FSI_2009", "FSI_2010",
  "FSI_2011", "FSI_2012", "FSI_2013", "FSI_2014", "FSI_2015",
  "FSI_2016", "FSI_2017", "FSI_2018", "FSI_2019", "FSI_2020",
  "FSI_2021", "FSI_2022", "FSI_2023"
)

# Loop through each dataframe name and print its structure using str() to confirm data types.
for (name_str in df_all_years) {
  if (exists(as.character(name_str), envir = .GlobalEnv)) {
    df_obj = get(as.character(name_str), envir = .GlobalEnv) # Get the dataframe object from its name
    cat(paste0("Structure for ", name_str, ":\n"))
    str(df_obj)
    cat("\n") # Add a newline for better readability between dataframes
  } else {
    cat(paste0("DataFrame ", name_str, " does not exist.\n\n"))
  }
}
```

```{r}
# initiate a loop to convert all rank columns to integer Values

# Loop through each dataframe to convert the 'Rank' column to an integer
for (name_str in df_all_years) {
  if (exists(as.character(name_str), envir = .GlobalEnv)) {
    df_obj = get(as.character(name_str), envir = .GlobalEnv)

    # Check if 'Rank' column exists and is character
    if ("Rank" %in% names(df_obj) && is.character(df_obj$Rank)) {
      # Extract numeric part from 'Rank' (e.g., '1st' -> 1, '2nd' -> 2)
      df_obj$Rank <- as.integer(gsub("[^0-9]", "", df_obj$Rank))
      cat(paste0("Converted 'Rank' column to integer in ", name_str, ".\n"))
    } else {
      cat(paste0("Rank column not found or not character in ", name_str, ".\n"))
    }

    assign(name_str, df_obj, envir = .GlobalEnv)
  } else {
    cat(paste0("DataFrame ", name_str, " does not exist.\n"))
  }
}

# Verify the changes for a couple of dataframes

str(FSI_2006$Rank)


str(FSI_2023$Rank)
```

```{r}
# initiate loop to convert year column to YYYY format and confirm change

# Load necessary library
install.packages("dplyr")
library(dplyr)

# Loop through each dataframe to clean the 'Year' column
for (name_str in df_all_years) {
  if (exists(as.character(name_str), envir = .GlobalEnv)) {
    df_obj = get(as.character(name_str), envir = .GlobalEnv)

    # Check if 'Year' column exists and needs conversion
    if ("Year" %in% names(df_obj) && is.numeric(df_obj$Year)) {

      # A simple heuristic: if the minimum year value is > 1900, assume it's an Excel serial date.
      # Excel serial dates typically start from 1 (Jan 1, 1900) or 0 (Jan 0, 1900, used by some systems).
      # Values like 38718 correspond to years in the 2000s.
      if (min(df_obj$Year, na.rm = TRUE) > 1900 && max(df_obj$Year, na.rm = TRUE) > 10000) {
        df_obj <- df_obj %>%
          mutate(Year = as.numeric(format(as.Date(Year, origin = "1899-12-30"), "%Y")))
        cat(paste0("Converted Excel serial dates to years in ", name_str, ".\n"))
      } else {
        cat(paste0("Year column in ", name_str, " appears to be already in YYYY format or not Excel serial dates.\n"))
      }
    } else {
      cat(paste0("Year column not found or not numeric in ", name_str, ".\n"))
    }

    assign(name_str, df_obj, envir = .GlobalEnv)
  } else {
    cat(paste0("DataFrame ", name_str, " does not exist.\n"))
  }
}

# Verify the changes for a couple of dataframes

print(unique(FSI_2006$Year))


print(unique(FSI_2012$Year))


print(unique(FSI_2021$Year))


print(unique(FSI_2023$Year))
```

```{r}
#display the column names for the 2023 file to confirm order is different from the others.

names(FSI_2023)

#reorder the column names to conform to the other files for further cleaning.
FSI_2023 <- FSI_2023[, c('Country','Year','Rank','Total','C1:.Security.Apparatus','C2:.Factionalized.Elites','C3:.Group.Grievance','E1:.Economy','E2:.Economic.Inequality','E3:.Human.Flight.and.Brain.Drain','P1:.State.Legitimacy','P2:.Public.Services','P3:.Human.Rights','S1:.Demographic.Pressures','S2:.Refugees.and.IDPs','X1:.External.Intervention')]

#adding a space between results to compare.

cat("\n")



names(FSI_2023)
```

```{r}
# replace all instances of ":." with "_" in the column headers for all the files

# Ensure stringr library is loaded
library(stringr)

# Loop through each dataframe to rename its columns
for (name_str in df_all_years) {
  if (exists(as.character(name_str), envir = .GlobalEnv)) {
    df_obj = get(as.character(name_str), envir = .GlobalEnv)

    # Rename columns: replace all instances of ':.' with '_'
    names(df_obj) <- str_replace_all(names(df_obj), ":\\.", "_")

    assign(name_str, df_obj, envir = .GlobalEnv) # Assign the modified dataframe back
  } else {
    cat(paste0("DataFrame ", name_str, " does not exist.\n"))
  }
}



# Verify the changes for a couple of dataframes

print(names(FSI_2006))


print(names(FSI_2023))
```

```{r}
# add another loop to replace all instances of "." with "_"

# Ensure stringr is still loaded
library(stringr)

# Loop through each dataframe to rename its columns
for (name_str in df_all_years) {
  if (exists(as.character(name_str), envir = .GlobalEnv)) {
    df_obj = get(as.character(name_str), envir = .GlobalEnv)

    # Rename columns: replace all instances of '.' with '_'
    # The double backslash `\\.` is needed to escape the dot, as dot is a special regex character.
    names(df_obj) <- str_replace_all(names(df_obj), "\\.", "_")

    assign(name_str, df_obj, envir = .GlobalEnv) # Assign the modified dataframe back
  } else {
    cat(paste0("DataFrame ", name_str, " does not exist.\n"))
  }
}



# Verify the changes for a couple of dataframes

print(names(FSI_2006))


print(names(FSI_2023))
```

```{r}
# Combine all files into a single data frame

# Ensure df_all_years is defined (it contains the names of the individual FSI dataframes)

df_all_years = c(
  "FSI_2006", "FSI_2007", "FSI_2008", "FSI_2009", "FSI_2010",
  "FSI_2011", "FSI_2012", "FSI_2013", "FSI_2014", "FSI_2015",
  "FSI_2016", "FSI_2017", "FSI_2018", "FSI_2019", "FSI_2020",
  "FSI_2021", "FSI_2022", "FSI_2023"
)

# Get the actual dataframe objects from their names

df_list <- mget(df_all_years)

# Combine all dataframes in the list vertically (row-wise)
# do.call(rbind, ...) is used to call rbind with a list of arguments

FSI_combined <- do.call(rbind, df_list)



# Display the first few rows of the combined dataframe


print(head(FSI_combined))

# Display the dimensions of the combined dataframe


print(dim(FSI_combined))

# Also confirm the unique years in the combined dataframe


print(unique(FSI_combined$Year))
```

```{r}
# Convert the 'Year' column to integer type
FSI_combined$Year <- as.integer(FSI_combined$Year)



# Verify the change in data type

str(FSI_combined$Year)
```

```{r}
# Reset the row names of the combined dataframe, replacing the complex row names with simple sequential numbers and remove the old row names from being considered a column.
FSI_combined <- FSI_combined %>%
  tibble::rowid_to_column("Original_Row_Index") %>%
  select(-Original_Row_Index) # Remove the temporarily added column if not needed




# Display the first few rows again to confirm the change

print(head(FSI_combined))
```

```{r}
# Ensure ggplot2 is installed and loaded
library(ggplot2)

# Create the box plot
fsi_boxplot <- ggplot(FSI_combined, aes(x = factor(Year), y = Total)) +
  geom_boxplot(fill = "steelblue", color = "darkblue", outlier.colour = "red", outlier.shape = 1) +
  labs(
    title = "Distribution of Fragile States Index Total Score by Year",
    x = "Year",
    y = "Total Score"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Display the plot
print(fsi_boxplot)
```

```{r}
# Ensure ggplot2 is installed and loaded


library(ggplot2)

# Aggregate the FSI_combined data to get the average 'Total' per 'Year',  mean function utilized.
FSI_yearly_total <- FSI_combined %>%
  group_by(Year) %>%
  summarise(Average_Total = mean(Total, na.rm = TRUE)) %>%
  ungroup()

# Create the line plot
fsi_total_plot <- ggplot(FSI_yearly_total, aes(x = Year, y = Average_Total)) +
  geom_line(color = "steelblue", linewidth = 1.2) + # Changed 'size' to 'linewidth'
  geom_point(color = "darkblue", size = 3) +
  labs(
    title = "Average Fragile States Index Total Score Over Years",
    x = "Year",
    y = "Average Total Score"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Display the plot
print(fsi_total_plot)

#the plot shows a major drop in the total score around 2020, indicating a possible connection to the COVID-19 pandemic.
```



```{r}
# Reinstall and reload rlang, dplyr, and ggplot2 to resolve the 'ffi_list2' error

# Reinstall rlang (it's often the root cause for ffi_list2 errors)
install.packages("rlang", dependencies = TRUE)

# Reinstall dplyr and ggplot2 to ensure compatibility with the reinstalled rlang
install.packages("dplyr", dependencies = TRUE)
install.packages("ggplot2", dependencies = TRUE)
install.packages("tidyr")


# Reload the libraries
library(rlang)
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)



```

```{r}
# Ensure ggplot2 and dplyr are loaded
library(ggplot2)
library(dplyr)

# Define the years and variables of interest.
years_to_plot <- c(2013, 2023)
variables_to_plot <- c("C1_Security_Apparatus", "C2_Factionalized_Elites", "C3_Group_Grievance")

# Filter the combined dataframe for the specified years and variables
data_for_histograms <- FSI_combined %>%
  filter(Year %in% years_to_plot) %>%
  select(Year, all_of(variables_to_plot)) %>%

  # Convert data to long format for easier faceting with ggplot2
  tidyr::pivot_longer(cols = all_of(variables_to_plot), names_to = "Indicator", values_to = "Score")

# Create the histograms using facet_wrap to help with vizualization.
histogram_plot <- ggplot(data_for_histograms, aes(x = Score, fill = factor(Year))) +
  geom_histogram(binwidth = 0.5, position = "identity", alpha = 0.6, color = "black") +
  facet_wrap(~ Indicator + Year, scales = "free_y", ncol = length(years_to_plot)) + # Reverted to facet_wrap
  labs(
    title = "Distribution of Selected FSI Indicators in 2013 and 2023",
    x = "Score",
    y = "Frequency",
    fill = "Year"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    strip.text = element_text(face = "bold"),
    legend.position = "bottom"
  )

# Display the plot
print(histogram_plot)

#security apparatus had a similar distribution of the comparission years, but 2023 had lower peaks overall.
#Factionalized elites shows similar patterns between years with each comparission year showing left-skews.
#Group greivance are very similar between comparrision years.
#all variables had lower maximums in 2023 compared to 2013.
```

